# Pertuna 시뮬레이터 설계 문서

## 1. 개요

이 문서는 동원 신제품 월별 수요 예측을 위한 `Pertuna` 프로젝트의 시뮬레이터(`simulator.py`) 설계에 대해 기술합니다. 시뮬레이터는 LLM(거대 언어 모델)을 통해 생성된 가상 소비자 페르소나를 기반으로, 각 제품의 12개월간 월별 판매량을 예측하는 것을 목표로 합니다.

이 문서는 초기 모델부터 최종 개선안까지의 발전 과정과 최종적으로 확립된 시뮬레이션 로직의 상세 내용을 포함합니다.

---

## 2. 모델 발전 과정

시뮬레이터는 더 현실적이고 정교한 예측을 위해 다음과 같은 단계로 발전했습니다.

*   **v1: 초기 모델 (이진 결정 모델)**
    *   구매 확률에 기반해 구매 여부를 `True/False`로 결정.
    *   구매 시, 페르소나의 `평균 구매 수량`이라는 고정된 값을 더함.
    *   **한계:** 행동이 너무 단순하고, 페르소나의 다양한 특성을 제대로 활용하지 못함.

*   **v2: 통계 모델 개선 (푸아송 분포 도입)**
    *   단순 `True/False` 결정을 넘어, '월별 기대 구매량(λ)'을 평균으로 갖는 **푸아송 분포**에서 구매량을 샘플링하는 방식으로 변경.
    *   이를 통해 구매 행동을 보다 현실적인 확률 분포 모델로 개선.

*   **v3: 최종 모델 (페르소나 속성 역할 재정의 및 상세 로직 확립)**
    *   페르소나의 다양한 속성이 시뮬레이션에 어떻게 기여하는지에 대한 명확한 철학과 근거(Rationale)를 확립.
    *   LLM이 페르소나의 질적 특성을 종합하여 평가하는 `제품 적합도` 개념을 도입하여 시뮬레이션의 핵심 기준으로 삼음.

---

## 3. 최종 시뮬레이션 설계 철학

최종 모델은 페르소나의 구매 행동을 **4가지 핵심 요소**로 분리하여, 각 요소가 시뮬레이션에서 명확하고 독립적인 역할을 수행하도록 설계되었습니다.

| 요소 분류 | 해당 속성 | 역할 | 설명 |
| :--- | :--- | :--- | :--- |
| **근거 (Rationale)** | `성격`, `직업`, `취미` 등 질적(Qualitative) 속성 | **점수 부여의 근거** | LLM이 아래의 `제품 적합도`와 `민감도` 점수들을 합리적으로 생성하기 위한 논리적 바탕. 시뮬레이션에 직접 사용되진 않지만, 점수의 품질을 결정. |
| **내재적 선호도 (Static Preference)** | `제품 적합도` | **기본 구매 성향** | 페르소나의 고유 특성을 바탕으로 한 제품의 근본적인 선호도. (e.g. "나는 원래 이 제품을 얼마나 좋아하는가?") |
| **상황적 민감도 (Dynamic Sensitivity)** | `가격 민감도`, `마케팅 영향력`, `계절성 구매 성향` 등 | **외부 자극에 대한 반응** | 물가, 광고, 계절 등 외부 환경 변화에 페르소나가 얼마나 민감하게 반응하는지를 조절하는 계수. (e.g. "나는 할인을 하면 얼마나 더 사는가?") |
| **구매 규모 (Scale)** | `평균 구매 수량` | **구매량의 크기** | 구매 행동이 발생했을 때, 한 번에 얼마나 많이 구매하는지를 결정. |

---

## 4. 최종 시뮬레이션 계산 로직

`simulate_monthly_demand` 함수의 계산은 다음 4단계로 이루어집니다.

#### 1단계: 기본 구매 성향 점수 계산

LLM이 생성한 `제품 적합도` 점수(1~10점)를 10으로 나누어 페르소나의 **기본 구매 성향 점수(Base Propensity Score)**를 계산합니다.

```
base_propensity = persona['제품 적합도'] / 10.0
```

#### 2단계: 상황적 민감도 적용 및 최종 성향 점수 조정

기본 구매 성향 점수에 외부 시장 데이터(`external_data`)와 페르소나의 각종 민감도 속성을 곱하여 **최종 구매 성향 점수(Adjusted Propensity Score)**를 계산합니다. 이 점수는 0 이상이 될 수 있습니다.

```
# 예시: 가격 민감도 적용
adjusted_propensity = base_propensity * (1 + (food_cpi_impact - 1) * price_sensitivity)

# 예시: 마케팅 민감도 적용
adjusted_propensity *= (1 + (marketing_boost - 1) * marketing_sensitivity)

# ... (기타 모든 민감도에 대해 반복) ...
```

#### 3단계: 월별 기대 구매량(λ) 계산

조정된 최종 구매 성향 점수에 페르소나의 `평균 구매 수량`을 곱하여, 푸아송 분포의 평균이 될 **월별 기대 구매량(λ, Lambda)**을 계산합니다.

```
lambda = adjusted_propensity * persona['평균 구매 수량']
```

#### 4단계: 푸아송 분포를 이용한 최종 구매량 샘플링

계산된 람다(λ) 값을 평균으로 하는 푸아송 분포에서 랜덤 값을 샘플링하여 해당 월의 최종 구매량을 확정합니다.

```python
final_purchase_quantity = numpy.random.poisson(lam=lambda)
```

### 5. 최종 집계

각 페르소나별, 시뮬레이션 횟수별로 계산된 `final_purchase_quantity`를 모두 더한 후, 시장의 실제 규모를 반영하기 위한 보정 상수(`market_multiplier`)를 곱하여 최종 월별 판매량을 결정합니다.

```
scaled_sales = round(total_simulated_sales * market_multiplier)
```
